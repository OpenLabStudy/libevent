/**
 * @file test_uart_event_reopen.cpp
 * @brief GoogleTest for R632 Binary Parser (uart_event_reopen.c)
 *
 * 빌드:
 *   g++ -O2 -Wall -Wextra -o test_uart_event_reopen \
 *       test_uart_event_reopen.cpp uart_event_reopen.c \
 *       -levent -lgtest -lpthread -lm
 */

 #include <gtest/gtest.h>
 #include <cstring>
 #include <vector>
 #include <iostream>
 
 extern "C" {
     #include "../r632Gps.h"
 }
 
 // -----------------------------
 // 샘플 데이터 정의
 // -----------------------------
 static const uint8_t SAMPLE_FRAME1[] = {
     0x24,0x42,0x49,0x4E,0x03,0x00,0x74,0x00,0x29,0x9A,0x99,0x99,0xE3,0xBE,0x15,0x41,0x09,0x09,0x2B,0x00,
     0x29,0x00,0x04,0x00,0x22,0x64,0xF4,0x9E,0x82,0x9E,0x42,0x40,0x8C,0x35,0x50,0xBD,0xE0,0x47,0x60,0x40,
     0xA0,0x79,0x12,0x42,0x8C,0x83,0x84,0x40,0x53,0xBD,0x2D,0x3D,0xC3,0x74,0xE2,0x41,0x3C,0xC2,0x52,0x43,
     0xBA,0xCF,0x11,0x3F,0xD3,0x2E,0x45,0x3F,0x07,0x00,0x11,0x02,0xE5,0xF7,0xCD,0x3D,0x91,0xC7,0xFA,0x3D,
     0xFB,0x8F,0xC6,0x3E,0x02,0xEC,0x19,0x3F,0xFF,0xFE,0xEE,0x3E,0xED,0x43,0x39,0x3F,0x9B,0x35,0x01,0x3F,
     0xC1,0x24,0xB0,0x3D,0x39,0x10,0x07,0xBC,0xF5,0x64,0x9B,0xBD,0x51,0xE1,0x83,0x3D,0x6E,0x5D,0x3F,0xBC,
     0xE9,0x17,0xB9,0x3E,0x2C,0x32,0x0D,0x0A
 };
 
 static const uint8_t SAMPLE_FRAME2[] = {
     0x24,0x42,0x49,0x4E,0x03,0x00,0x74,0x00,0xBB,0xCC,0xCC,0xCC,0xE3,0xBE,0x15,0x41,0x09,0x09,0x2B,0x00,
     0x29,0x00,0x04,0x00,0x20,0x04,0xC9,0xAC,0x82,0x9E,0x42,0x40,0xB9,0x62,0x9C,0xBF,0xE0,0x47,0x60,0x40,
     0xBE,0x7B,0x12,0x42,0xD1,0xB1,0x84,0x40,0x6E,0x72,0x2D,0x3D,0x7D,0x65,0xDD,0x41,0x47,0xC2,0x52,0x43,
     0xFD,0x87,0x13,0x3F,0x84,0xD4,0x3B,0x3F,0x07,0x00,0x11,0x02,0x0D,0x57,0xCE,0x3D,0xAA,0x47,0xFB,0x3D,
     0xFB,0x8F,0xC6,0x3E,0x02,0xEC,0x19,0x3F,0xFF,0xFE,0xEE,0x3E,0xED,0x43,0x39,0x3F,0x9B,0x35,0x01,0x3F,
     0xC1,0x24,0xB0,0x3D,0x39,0x10,0x07,0xBC,0xF5,0x64,0x9B,0xBD,0x51,0xE1,0x83,0x3D,0x6E,0x5D,0x3F,0xBC,
     0xE9,0x17,0xB9,0x3E,0x00,0x32,0x0D,0x0A
 };
 
 // -----------------------------
 // Helper 함수
 // -----------------------------
 static SGpsDataInfo FeedOnce(const uint8_t* data, int len, SGpsDataInfo* ctx)
 {
     R632Feed(data, len, ctx);
     return *ctx;
 }
 
 // -----------------------------
 // 테스트 시작
 // -----------------------------
 
 TEST(R632ParserTest, ValidFrame)
 {
     SGpsDataInfo info{};
     memset(&info, 0, sizeof(info));
 
     char ret = R632Feed(SAMPLE_FRAME1, sizeof(SAMPLE_FRAME1), &info);
     EXPECT_EQ(ret, 1);
     EXPECT_EQ(info.m_chOk, 1);
     EXPECT_NEAR(info.m_stMsg3.m_dLatitude, 37.0, 10.0); // 대략적 값 검증
     EXPECT_NEAR(info.m_stMsg3.m_dLongitude, 127.0, 10.0);
     std::cout << "UTC: " << info.m_szTime << std::endl;
 }
 
 TEST(R632ParserTest, FragmentedFrame)
 {
     SGpsDataInfo info{};
     memset(&info, 0, sizeof(info));
 
     int half = sizeof(SAMPLE_FRAME1) / 2;
     char ret1 = R632Feed(SAMPLE_FRAME1, half, &info);
     EXPECT_EQ(ret1, 0); // 첫 조각은 불완전 → 실패
     char ret2 = R632Feed(SAMPLE_FRAME1 + half, sizeof(SAMPLE_FRAME1) - half, &info);
     EXPECT_EQ(ret2, 1); // 두 번째까지 합쳐야 성공
     EXPECT_EQ(info.m_chOk, 1);
 }
 
 TEST(R632ParserTest, CrcBrokenFrame)
 {
     SGpsDataInfo info{};
     memset(&info, 0, sizeof(info));
 
     std::vector<uint8_t> broken(SAMPLE_FRAME1, SAMPLE_FRAME1 + sizeof(SAMPLE_FRAME1));
     broken[10] ^= 0xFF; // CRC 계산에 영향을 줄 바이트 손상
 
     char ret = R632Feed(broken.data(), broken.size(), &info);
     EXPECT_EQ(ret, 0);  // CRC 불일치로 실패
     EXPECT_EQ(info.m_chOk, 0);
 }
 
 TEST(R632ParserTest, MergedTwoFrames)
 {
     SGpsDataInfo info{};
     memset(&info, 0, sizeof(info));
 
     std::vector<uint8_t> merged;
     merged.insert(merged.end(), SAMPLE_FRAME1, SAMPLE_FRAME1 + sizeof(SAMPLE_FRAME1));
     merged.insert(merged.end(), SAMPLE_FRAME2, SAMPLE_FRAME2 + sizeof(SAMPLE_FRAME2));
 
     char ret1 = R632Feed(merged.data(), merged.size(), &info);
     EXPECT_EQ(ret1, 1); // 첫 번째 성공
     EXPECT_EQ(info.m_chOk, 1);
 
     // 두 번째 프레임이 버퍼에 남아있을 것이므로 한 번 더 호출
     char ret2 = R632Feed(nullptr, 0, &info);
     EXPECT_TRUE(ret2 == 1 || ret2 == 0); // 남은 프레임이 있다면 1
 }
 
 